sudo: required
services:
  - docker

before_install:
  - docker build -t huiying530/fib_calculator_test -f /client/Dockerfile.dev client

script:
  - docker run -e CI=true huiying530/fib_calculator npm run test

after_success:
  - docker build -t huiying530/fib_calculator_client client
  - docker build -t huiying530/fib_calculator_nginx nginx 
  - docker build -t huiying530/fib_calculator_server server 
  - docker build -t huiying530/fib_calculator_worker worker
  - echo "$DOCKER_PWD" | docker login -u "$DOCKER_ID" --password-stdin
  - docker push huiying530/fib_calculator_client
  - docker push huiying530/fib_calculator_nginx
  - docker push huiying530/fib_calculator_server
  - docker huiying530/fib_calculator_worker

deploy:
  provider: elasticbeanstalk
  region: ap-southeast-1
  app: "fib-calculator"
  env: "Fib-calculator-env"
  bucket_name: elasticbeanstalk-ap-southeast-1-083597744184
  bucket_path: "fib-calculator"
  on:
    branch: main
  access_key_id: "$AWS_ACCESS_KEY"
  secret_access_id: "$AWS_SECRET_KEY"